<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>task4</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <style>
        body {
            background-color: white;
        }

        /*#control {*/
            /*margin-left: 100px;*/
        /*}*/

        input[type='range'] {
            -webkit-appearance: none !important;
            -webkit-border-radius: 5px;
            -webkit-box-shadow: inset 0 0 5px #333;
            background-color: #e3e3e3;
            height: 10px;
            width: 200px;
            margin: 20px;
            /*position: relative;
             left: 10%;*/
        }

        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            -webkit-border-radius: 15px;
            background-color: #c3c3c3;
            /*background-image: -webkit-gradient(linear, left top, left bottom, from(#bbb), to(#888));*/
            border: 0.5px solid #333;
            height: 25px;
            width: 25px;
        }

        #range {

            font: 15px sans-serif;
        }

        button {
            width: 60px;
            height: 30px;
            background: #c3c3c3;
            border: 0.5px solid #333;
            border-radius: 4px;
            color: #333;
            font-size: 17px;
            margin-left: 10px;
        }

        .country {
            fill: #e3e3e3;
            stroke: #828282;
            stroke-width: .5px;
        }

        .selected {
            fill: #c3c3c3;
        }

        .hidden {
            display: none;
        }

        div.tooltip {
            font-family: Arial, Helvetica, sans-serif;
            color: #000;
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 0 2px 0 #a6a6a6;
            padding: .2em;
            text-shadow: #f5f5f5 0 1px 0;
            opacity: 0.6;
            position: absolute;
        }

        div.info_window {
            font-family: Arial, Helvetica, sans-serif;
            color: #000;
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 0 2px 0 #a6a6a6;
            padding: .2em;
            text-shadow: #f5f5f5 0 1px 0;
            opacity: 0.6;
            position: absolute;
        }

        .graticule {
            fill: none;
            stroke: #d8d8d8;
            stroke-width: .5px;
        }
    </style>

</head>

<body>
<div id="control">
    <input id="slider" type="range" min="2000" max="2011" value="2000" step="1"/>

    <span id="range">1970</span>

    <button name="play" id="play">Play</button>
</div>

<div id="map"></div>
<script>
    let num = 1.8,
        width = 868 * num,
        height = 500 * num,
        scale = 159 * num,
        mouseon_text_margin = 15,
        radius = 4,
        color_scale = 500;

    let graticule = d3.geo.graticule();

    let projection = d3.geo.kavrayskiy7()
        .scale(scale)
        .translate([width / 2, height / 2]);

    let svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    let path = d3.geo.path()
        .projection(projection);

    let colorScale = d3.scaleLinear()
        .domain([color_scale, 0])
        .range(["rgb(46, 73, 123)", "rgb(71, 187, 94)"]);

    colorScale = d3.scaleSequential(d3.interpolateMagma)
        .domain([color_scale, 0]);

    let tool_tip = d3.select("#map")
        .append("div")
        .attr("class", "tooltip hidden");

    let info_window = d3.select("#map")
        .append("div")
        .attr("class", "info_window hidden");

    queue()
        .defer(d3.json, "world-110m2.json")
        .defer(d3.tsv, "world-country-names.tsv")
        .defer(d3.csv, "gtd_70to94.csv")
        .await(ready);

    function ready(error, country_data, country_name, gtd) {

        let countries = topojson.feature(country_data, country_data.objects.countries).features;
        countries = countries.filter(function (d) {
            return country_name.some(function (n) {
                if (d.id == n.id) return d.name = n.name
            })
        });

        svg.append("g")
            .selectAll(".country")
            .data(countries)
            .enter().append("path")
            .attr("class", "country")
            .attr("d", path)
            .on("mouseover", function (d) {
                d3.select(this).classed("selected", true);
            })
            .on("mousemove", showTooltip)
            .on("mouseout", function (d, i) {
                d3.select(this).classed("selected", false);
                tool_tip.classed("hidden", true);
            });

        svg.append("g")
            .append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);

        svg.append("g")
            .append("path")
            .datum(graticule.outline)
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("d", path);

        svg.append("g")
            .selectAll(".incident-circle")
            .data(gtd)
            .enter().append("circle")
            .attr("r", radius)
            .attr("cx", function (d) {
                // let coords = projection([d.longitude,d.latitude]);
                // return coords[0];
                return yieldCoords(d).next().value[0];
            })
            .attr("cy", function (d) {
                // let coords = projection([d.longitude,d.latitude]);
                // return coords[1];
                return yieldCoords(d).next().value[1];
            })
            .attr("fill", d => colorScale(d.nkill))
            .on("click", showInfoWindow)
            .on("mouseout", function (d, i) {
                info_window.classed("hidden", true);
            })
    }

    function* yieldCoords(d) {
        let coords = projection([d.longitude, d.latitude]);
        yield coords;
    }

    function showTooltip(d) {
        label = d.name;
        let mouse = d3.mouse(svg.node())
            .map(function (d) {
                return parseInt(d);
            });
        tool_tip.classed("hidden", false)
            .attr("style", "left:" + (mouse[0] + mouseon_text_margin) + "px;top:" + (mouse[1] + mouseon_text_margin) + "px")
            .html(label);
    }

    function showInfoWindow(d) {
        label = "Year: " + d.iyear + "<br>Kill: " + d.nkill + "<br>Wound: " + d.nwound + "<br>Property: " + d.propvalue;
        let mouse = d3.mouse(svg.node())
            .map(function (d) {
                return parseInt(d);
            });
        tool_tip.classed("hidden", false)
            .attr("style", "left:" + (mouse[0] + mouseon_text_margin) + "px;top:" + (mouse[1] + mouseon_text_margin) + "px")
            .html(label);
    }
</script>
</body>
</html>